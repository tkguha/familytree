<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Family Lineage Tree — Debug</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body{ margin:0; font-family:Arial, sans-serif; background:#f5f8fb; }
    header{ background:#2196f3; color:#fff; padding:12px; text-align:center; font-weight:600; }
    #status { padding:10px 16px; font-size:13px; color:#222; }
    svg{ width:100%; height:calc(100vh - 110px); background:#fff; display:block; }
    .note { color:#666; font-size:13px; padding:8px 16px; }
  </style>
</head>
<body>
  <header>Guha Family Lineage Tree — Debug Build</header>
  <div id="status">Status: Loading… (check console for detailed logs)</div>
  <div class="note">This debug build logs steps to the browser console and shows errors as alerts so we can find the failure.</div>
  <svg></svg>

<script>
(function(){
  const STATUS = id => { document.getElementById('status').textContent = 'Status: ' + id; console.log('[STATUS]', id); };
  const ERR = (msg, err) => { console.error('[ERROR]', msg, err); try{ alert(msg + (err ? '\\nSee console for details.' : '')); }catch(e){} };

  STATUS('Script started — checking D3 loaded');

  if (typeof d3 === 'undefined') {
    ERR('D3.js not loaded. Please ensure the script tag for D3 is present and reachable.');
    return;
  } else {
    console.log('d3 version:', d3.version);
  }

  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTxk4d1BIyeRjHKnaPh_D2SgbpxqjPNnck4sz3PSpocQKgkl2A54-v92UT09ov-x1ibJNgLaSrBgdsX/pub?gid=0&single=true&output=csv";

  STATUS('Fetching CSV to test availability: ' + csvUrl);
  // fetch the csv first to check response and CORS
  fetch(csvUrl, { method: 'GET', mode: 'cors' })
    .then(response => {
      console.log('CSV fetch response:', response);
      if (!response.ok) throw new Error('CSV fetch failed: HTTP ' + response.status);
      // log headers that might indicate blocking
      console.log('Response headers:', Array.from(response.headers.entries()));
      return response.text();
    })
    .then(txt => {
      console.log('CSV text length:', txt.length);
      // show first 400 chars as preview
      console.log('CSV preview:\\n', txt.slice(0,400).replace(/\\n/g,'\\n'));
      STATUS('CSV fetched OK — parsing via d3.csvParse');

      let rows;
      try {
        rows = d3.csvParse(txt);
        console.log('Parsed rows count:', rows.length);
      } catch(parseErr) {
        ERR('CSV parsing failed', parseErr);
        return;
      }

      if (!rows || rows.length === 0) {
        ERR('CSV parsed but no rows were found. Check your published sheet contains rows and headers.');
        return;
      }

      // minimal sanity checks for required columns
      const example = rows[0];
      console.log('Example row:', example);
      const cols = Object.keys(example).map(k=>k.toLowerCase());
      console.log('Columns (lowercased):', cols);
      const required = ['id','name','parentid'];
      const missing = required.filter(r => !cols.includes(r));
      if (missing.length) {
        ERR('CSV is missing required columns: ' + missing.join(', ') + '. Expected headers (case-insensitive): ID, Name, ParentID');
        return;
      }

      STATUS('Data OK — building tree (debug mode)');

      // Use a minimal safe build of tree to ensure no exceptions later
      try {
        // convert to normalized objects
        const rowsNormalized = rows.map(r => ({
          ID: (r.ID||r.id||'').toString().trim(),
          Name: (r.Name||r.name||'').toString().trim(),
          ParentID: (r.ParentID||r.parentid||'').toString().trim(),
          PhotoURL: (r.PhotoURL||'').toString().trim(),
          Details: (r.Details||'').toString().trim()
        }));
        console.log('Normalized rows first 3:', rowsNormalized.slice(0,3));

        // build map
        const map = {};
        rowsNormalized.forEach(r => { map[r.ID] = {...r, children: []}; });
        let rootObj = null;
        rowsNormalized.forEach(r => {
          if (r.ParentID && map[r.ParentID]) {
            map[r.ParentID].children.push(map[r.ID]);
          } else {
            // treat as candidate root; keep first as root if multiple
            if (!rootObj) rootObj = map[r.ID];
          }
        });
        if (!rootObj) rootObj = rowsNormalized.length ? map[rowsNormalized[0].ID] : null;
        if (!rootObj) throw new Error('Could not determine root from CSV rows.');

        console.log('Root object ID:', rootObj && rootObj.ID, 'Name:', rootObj && rootObj.Name);

        // create d3 hierarchy and minimal rendering to test
        const root = d3.hierarchy(rootObj, d => d.children && d.children.length ? d.children : null);
        console.log('Hierarchy built. Depth:', root.height, 'Nodes:', root.descendants().length);

        // minimal render: append one text so we can see something
        const svg = d3.select('svg');
        svg.selectAll('*').remove();
        const g = svg.append('g').attr('transform','translate(40,40)');
        g.append('text').text('Tree loaded — nodes: ' + root.descendants().length).attr('fill','#111');

        STATUS('Minimal render displayed. Full D3 tree code will run next.');

        // Now call your existing full update function (if you have it).
        // For safety we'll call a wrapped function (if defined) otherwise stop.
        if (typeof runFullTree === 'function'){
          console.log('Found runFullTree() — invoking it now.');
          try {
            runFullTree(rowsNormalized);
            STATUS('runFullTree completed.');
          } catch(e) {
            ERR('runFullTree threw an exception', e);
          }
        } else {
          console.log('No runFullTree() found — leaving debug message. Replace with full tree build next.');
        }

      } catch (e) {
        ERR('Exception while building minimal tree', e);
      }

    })
    .catch(err => {
      ERR('Failed to fetch CSV. Possible causes: sheet not published, blocked by CORS, or network error.', err);
    });

  // For convenience: expose some keys to window for debugging
  window.__family_debug = { csvUrl };

})(); // IIFE end
</script>

</body>
</html>
