<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<title>Family Lineage Tree</title>

<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: linear-gradient(to bottom right, #e8f1ff, #f8fbff);
        overflow: hidden;
    }

    /* Fixed Header */
    header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.85);
        padding: 10px 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        backdrop-filter: blur(6px);
        z-index: 1000;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    header h1 {
        margin: 0;
        font-size: 20px;
        font-weight: bold;
    }

    #searchBox {
        padding: 6px 10px;
        width: 200px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 14px;
    }

    /* Info Box (Fixed) */
    #infoBox {
        position: fixed;
        top: 60px;
        right: 15px;
        background: white;
        width: 250px;
        padding: 10px;
        border-radius: 8px;
        font-size: 13px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        z-index: 999;
    }

    /* Tree Container */
    #treeContainer {
        position: absolute;
        top: 110px;
        left: 0;
        right: 0;
        bottom: 35px;
        overflow: auto;
    }

    /* Node Card */
    .nodeCard {
        background: white;
        border: 1px solid #bbb;
        border-radius: 8px;
        padding: 6px;
        text-align: center;
        min-width: 110px;
        max-width: 200px;
        font-size: 13px;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .end-branch {
        border: 2px solid red !important;
        background: #ffe5e5 !important;
    }

    /* Round Photo */
    .photo {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 4px;
        border: 1px solid #888;
    }

    /* Footer */
    footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        background: rgba(255,255,255,0.9);
        padding: 5px 10px;
        text-align: center;
        font-size: 12px;
        border-top: 1px solid #ccc;
        z-index: 1000;
    }

</style>
</head>

<body>
<header>
    <h1>Guha Family Lineage Tree</h1>
    <input type="text" id="searchBox" placeholder="Search name..." />
</header>

<div id="infoBox">
    <b>About:</b><br>
    A dynamic 16-generation family tree.<br><br>
    ‚úÖ Click nodes to expand/collapse<br>
    ‚úÖ Search & jump to any member<br>
    ‚úÖ Red border = End of branch<br>
    üìå Photos supported in CSV (PhotoURL col.)
</div>

<div id="treeContainer"></div>

<footer>
    Created with ‚ù§Ô∏è ‚Äî <a href="#" target="_blank">About this project</a>
</footer>

<script>
// ------------------ LOAD CSV ------------------
fetch("data/family.csv")
    .then(response => response.text())
    .then(csv => {
        const rows = d3.csvParse(csv);
        buildTree(rows);
    })
    .catch(err => {
        alert("‚ùå Failed to load family.csv\nCheck if /data/family.csv exists.");
        console.error(err);
    });

// ------------------ BUILD TREE ------------------
function buildTree(rows) {
    const dataMap = {};
    rows.forEach(d => dataMap[d.ID] = d);

    const rootData = rows.find(d => d.ParentID === "" || d.ParentID === "0");
    const root = d3.hierarchy(buildNode(rootData));

    function buildNode(d) {
        const children = rows.filter(x => x.ParentID === d.ID);
        return { ...d, children: children.map(buildNode) };
    }

    const width = 1800, height = 2000;

    const svg = d3.select("#treeContainer").append("svg")
        .attr("width", width)
        .attr("height", height)
        .call(d3.zoom().on("zoom", (event) => {
            g.attr("transform", event.transform);
        }));

    const g = svg.append("g").attr("transform", "translate(50,50)");

    const treeLayout = d3.tree().nodeSize([120, 200]);
    treeLayout(root);

    const link = g.selectAll(".link")
        .data(root.links())
        .enter()
        .append("path")
        .attr("d", d3.linkHorizontal()
            .x(d => d.y)
            .y(d => d.x))
        .attr("fill", "none")
        .attr("stroke", "#666");

    const node = g.selectAll(".node")
        .data(root.descendants())
        .enter()
        .append("g")
        .attr("transform", d => `translate(${d.y},${d.x})`)
        .on("click", (_, d) => {
            d.children = d.children ? null : d._children;
            update();
        });

    node.append("foreignObject")
        .attr("width", 180)
        .attr("height", 130)
        .attr("x", -90)
        .attr("y", -55)
        .html(d => `
            <div class="nodeCard ${(!d.children && (!d._children)) ? "end-branch" : ""}">
                <img class="photo" src="${d.data.PhotoURL || "https://i.imgur.com/ZzQ5Q5Q.png"}" />
                <b>${d.data.Name}</b><br>
                <span style="font-size:11px">${d.data.DOB || ""}</span>
            </div>
        `);

    // Search Function
    document.getElementById("searchBox").addEventListener("keyup", function() {
        const val = this.value.toLowerCase();
        node.style("opacity", d => d.data.Name.toLowerCase().includes(val) ? 1 : 0.2);
    });
}
</script>

</body>
</html>
